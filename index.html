<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ejner Hessel – Lastbil Rapport</title>
  <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #n8n-chat { height: 100%; }

    /* Small floating recorder bar */
    #recorder-bar{
      position: fixed;
      bottom: 16px;
      left: 16px;
      z-index: 9999;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    #recBtn{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-family: system-ui, Segoe UI, Arial, sans-serif;
      font-size: 14px;
      white-space: nowrap;
    }
    #recStatus{
      font-family: system-ui, Segoe UI, Arial, sans-serif;
      font-size: 14px;
      background: rgba(255,255,255,0.9);
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #eee;
      max-width: min(900px, calc(100vw - 160px));
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div id="n8n-chat"></div>

  <!-- Recorder button -->
  <div id="recorder-bar">
    <button id="recBtn">Record</button>
    <span id="recStatus"></span>
  </div>

  <script type="module">
    import { createChat } from "https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js";

    // Your n8n Chat Trigger (production) webhook
    const WEBHOOK_URL = "https://jakework.app.n8n.cloud/webhook/4091fa09-fb9a-4039-9411-7104d213f601/chat";

    // Force stable key names (so we know exactly what the workflow expects)
    const CHAT_INPUT_KEY = "chatInput";
    const CHAT_SESSION_KEY = "sessionId";

    // Create/reuse a per-user sessionId (stored in THIS browser only)
    // This keeps multiple people separate automatically.
    const SESSION_ID_STORAGE_KEY = "eh_sessionId";
    function getOrCreateSessionId() {
      const existing = localStorage.getItem(SESSION_ID_STORAGE_KEY);
      if (existing) return existing;
      const fresh = crypto.randomUUID();
      localStorage.setItem(SESSION_ID_STORAGE_KEY, fresh);
      return fresh;
    }

    // ----- Chat widget -----
    createChat({
      webhookUrl: WEBHOOK_URL,
      mode: "fullscreen",

      // make sure widget uses the same keys
      chatInputKey: CHAT_INPUT_KEY,
      chatSessionKey: CHAT_SESSION_KEY,
      loadPreviousSession: true,

      // file uploads from the chat UI
      allowFileUploads: true,
      allowedFilesMimeTypes: "audio/*",

      // UI text
      showWelcomeScreen: true,
      initialMessages: [
        "Hej!",
        "Jeg er Ejner Hessel Lastbil Rapport-agenten. Skriv kundenavn og hvad du har lavet, eller optag via knappen så laver vi en rapport sammen!"
      ],
      i18n: {
        en: {
          title: "Ejner Hessel – Lastbil Rapport",
          subtitle: "",
          footer: "",
          getStarted: "Ny samtale",
          inputPlaceholder: "Skriv dit spørgsmål…"
        }
      }
    });

    // ----- Audio recorder -> injects into the chat widget upload input -----
    const recBtn = document.getElementById("recBtn");
    const recStatus = document.getElementById("recStatus");

    let mediaRecorder = null;
    let chunks = [];

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      chunks = [];

      const options = MediaRecorder.isTypeSupported("audio/webm;codecs=opus")
        ? { mimeType: "audio/webm;codecs=opus" }
        : undefined;

      mediaRecorder = new MediaRecorder(stream, options);

      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) chunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        // Stop mic
        stream.getTracks().forEach(t => t.stop());

        const blob = new Blob(chunks, { type: mediaRecorder.mimeType || "audio/webm" });
        const filename = `recording-${Date.now()}.webm`;

        recStatus.textContent = "Sending…";

        // Find the widget's file input (created when allowFileUploads=true)
        const fileInput = document.querySelector('#n8n-chat input[type="file"]');
        if (!fileInput) {
          recStatus.textContent = "Could not find chat upload input";
          return;
        }

        // Put the Blob into a File and “select” it
        const file = new File([blob], filename, { type: blob.type });
        const dt = new DataTransfer();
        dt.items.add(file);
        fileInput.files = dt.files;

        // Trigger the widget's upload handler
        fileInput.dispatchEvent(new Event("change", { bubbles: true }));

        recStatus.textContent = "";
      };

      mediaRecorder.start();
      recBtn.textContent = "Stop";
      recStatus.textContent = "Recording…";
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
      recBtn.textContent = "Record";
    }

    recBtn.addEventListener("click", async () => {
      try {
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
          await startRecording();
        } else {
          stopRecording();
        }
      } catch (err) {
        recStatus.textContent = "Mic permission denied / not available";
        console.error(err);
      }
    });
  </script>
</body>
</html>
