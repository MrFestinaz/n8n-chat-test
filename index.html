<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ejner Hessel – Lastbil Rapport</title>
  <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #n8n-chat { height: 100%; }

    #recorder-bar {
      position: fixed;
      bottom: 16px;
      left: 16px;
      z-index: 9999;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    #recBtn {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    #recStatus {
      font-size: 14px;
      background: rgba(255,255,255,0.9);
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #eee;
      max-width: min(900px, calc(100vw - 160px));
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div id="n8n-chat"></div>

  <div id="recorder-bar">
    <button id="recBtn">Record</button>
    <span id="recStatus"></span>
  </div>

  <script type="module">
    import { createChat } from "https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js";

    const WEBHOOK_URL =
      "https://jakework.app.n8n.cloud/webhook/4091fa09-fb9a-4039-9411-7104d213f601/chat";

    createChat({
      webhookUrl: WEBHOOK_URL,
      mode: "fullscreen",
      allowFileUploads: true,
      allowedFilesMimeTypes: "audio/*",
      loadPreviousSession: true,
      showWelcomeScreen: true,
      initialMessages: [
        "Hej!",
        "Jeg er Ejner Hessel Lastbil Rapport-agenten. Du kan skrive eller optage."
      ]
    });

    const recBtn = document.getElementById("recBtn");
    const recStatus = document.getElementById("recStatus");

    let mediaRecorder;
    let chunks = [];

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      chunks = [];

      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) chunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        stream.getTracks().forEach(t => t.stop());

        const blob = new Blob(chunks, { type: "audio/webm" });
        const file = new File([blob], `recording-${Date.now()}.webm`, {
          type: "audio/webm"
        });

        recStatus.textContent = "Uploading audio…";

        /* 1) Upload file THROUGH the widget */
        const fileInput = document.querySelector("#n8n-chat input[type=file]");
        if (!fileInput) {
          recStatus.textContent = "Chat upload input not found";
          return;
        }

        const dt = new DataTransfer();
        dt.items.add(file);
        fileInput.files = dt.files;
        fileInput.dispatchEvent(new Event("change", { bubbles: true }));

        /* 2) Wait so upload attaches to session */
        await new Promise(r => setTimeout(r, 1500));

        /* 3) Send marker message */
        const textarea = document.querySelector("#n8n-chat textarea");
        if (!textarea) {
          recStatus.textContent = "Chat input not found";
          return;
        }

        textarea.value = "__AUDIO_RECORDING__";
        textarea.dispatchEvent(new Event("input", { bubbles: true }));
        textarea.dispatchEvent(
          new KeyboardEvent("keydown", {
            key: "Enter",
            code: "Enter",
            bubbles: true
          })
        );

        recStatus.textContent = "";
      };

      mediaRecorder.start();
      recBtn.textContent = "Stop";
      recStatus.textContent = "Recording…";
    }

    function stopRecording() {
      mediaRecorder.stop();
      recBtn.textContent = "Record";
    }

    recBtn.onclick = async () => {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        await startRecording();
      } else {
        stopRecording();
      }
    };
  </script>
</body>
</html>

